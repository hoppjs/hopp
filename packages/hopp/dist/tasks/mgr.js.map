{"version":3,"sources":["../../src/tasks/mgr.js"],"names":["cache","debug","watchlog","log","plugins","Object","create","pluginConfig","gstatCache","isUndefined","value","undefined","Hopp","constructor","src","Array","pluginCtx","pluginArgs","d","stack","rename","plugin","fn","bind","method","dest","out","mapper","Error","push","doRename","filename","dirname","source","applyRename","basename","ext","substr","lastIndexOf","prefix","suffix","watch","name","directory","recache","watchers","forEach","newpath","resolve","nonMagic","recursive","indexOf","start","process","on","watcher","close","startBundling","modified","useDoubleCache","sourcemap","files","freshBuild","unmodified","file","originalFd","tmpBundle","tmpBundlePath","bundle","Date","now","stream","createReadStream","fd","autoClose","replace","end","concat","buildStack","add","reject","pipe","createWriteStream","map","that","mode","plugName","pluginStream","obj","data","_","done","args","handler","assign","err","retval","next","loadPlugin","taskName","mod","pathToPlugin","localPlugins","valOr","join","require","config","logger","pluginCache","error","safeTimeout","setTimeout","exit","needsBundling","needsRecaching","readonly","length","loadedPlugins","env","SKIP_BUILD","clearTimeout","outfile","hasOwnProperty","body","output","tmp","tmppath","promise","didFail","newStream","resolved","then","split","pop","localCache","relative","statSync","mtime","val","toJSON","fromJSON","json"],"mappings":"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","file":"../../src/tasks/mgr.js","sourcesContent":["/**\n * @file src/tasks/mgr.js\n * @license MIT\n * @copyright 2017 10244872 Canada Inc.\n */\n\nimport fs from 'fs'\nimport path from 'path'\nimport pump from 'pump'\nimport glob from '../fs/glob'\nimport through2 from 'through2'\nimport * as cache from '../cache'\nimport getPath from '../fs/get-path'\nimport { _, createLogger, simplifyError } from '../utils'\nimport { buffer, Bundle, createReadStream, map as mapStream } from '../streams'\nimport { disableFSCache, mkdirp, mkdirpSync, openFile, tmpFile, tmpFileSync } from '../fs'\n\nconst { debug } = createLogger('hopp')\nconst watchlog = createLogger('hopp:watch').log\n\n/**\n * Plugins storage.\n */\nconst plugins = Object.create(null)\nconst pluginConfig = Object.create(null)\n\n/**\n * The stat cache.\n */\nlet gstatCache\n\n/**\n * Test for undefined or null.\n */\nfunction isUndefined (value) {\n  return value === undefined || value === null\n}\n\n/**\n * Hopp class to manage tasks.\n */\nexport default class Hopp {\n  /**\n   * Creates a new task with the glob.\n   * DOES NOT START THE TASK.\n   *\n   * @param {Glob} src\n   * @return {Hopp} new hopp object\n   */\n  constructor (src) {\n    if (!(src instanceof Array)) {\n      src = [src]\n    }\n\n    // store context local to each task\n    this.pluginCtx = Object.create(null)\n\n    // store args separate from context to avoid arg collisions\n    // when a plugin has many methods\n    this.pluginArgs = Object.create(null)\n\n    // persistent info\n    this.d = {\n      src,\n      stack: [],\n      rename: []\n    }\n\n    // do local create\n    for (const plugin in Hopp.fn) {\n      this[plugin] = Hopp.fn[plugin].bind(this)\n\n      for (const method in Hopp.fn[plugin]) {\n        this[plugin][method] = Hopp.fn[plugin][method].bind(this)\n      }\n    }\n  }\n\n  /**\n   * Sets the destination of this pipeline.\n   * @param {String} out\n   * @return {Hopp} task manager\n   */\n  dest (out) {\n    this.d.dest = out\n    return this\n  }\n\n  /**\n   * Allow renaming of destination files.\n   * @param {Object|Function} mapper renaming options or renaming function\n   * @returns {Hopp} current object for chaining\n   */\n  rename (mapper) {\n    if (typeof mapper !== 'function' && typeof mapper !== 'object') {\n      throw new Error('Rename must be given a function or object.')\n    }\n\n    this.d.rename.push(mapper)\n    return this\n  }\n\n  /**\n   * Actually do the renaming.\n   * @param {String} filename the original name\n   * @param {String} dirname the destination directory\n   * @param {String} source the absolute source filename\n   * @returns {String} renamed filename\n   */\n  doRename (filename, dirname, source) {\n    let dest = dirname + '/' + filename\n\n    for (const mapper of this.d.rename) {\n      dest = this.applyRename(mapper, path.basename(dest), path.dirname(dest), source)\n    }\n\n    return dest\n  }\n\n  /**\n   * Apply a single rename.\n   * @param {Object|Function} mapper renaming object or function\n   * @param {String} filename the original name\n   * @param {String} dirname the destination directory\n   * @param {String} source the absolute source filename\n   * @returns {String} renamed filename\n   */\n  applyRename (mapper, filename, dirname, source) {\n    // if no rename is defined, just use current filename\n    if (!mapper) return dirname + '/' + filename\n\n    // functions are easy, but they break caching\n    if (typeof mapper === 'function') {\n      return mapper(filename, dirname, source)\n    }\n\n    // remove extension\n    let ext = filename.substr(1 + filename.lastIndexOf('.'))\n    filename = filename.substr(0, filename.lastIndexOf('.'))\n\n    // add prefix\n    if (mapper.prefix) {\n      filename = mapper.prefix + filename\n    }\n\n    // add suffix, before extension\n    if (mapper.suffix) {\n      filename += mapper.suffix\n    }\n\n    // change extension\n    if (mapper.ext) {\n      ext = mapper.ext\n    }\n\n    // output final filename into same dest directory\n    return dirname + '/' + filename + '.' + ext\n  }\n\n  /**\n   * Run task in continuous mode.\n   */\n  watch (name, directory, recache = false) {\n    name = `watch:${name}`\n\n    const watchers = []\n\n    this.d.src.forEach(src => {\n      // get most definitive path possible\n      let newpath = path.resolve(directory, glob.nonMagic(src))\n\n      // disable fs caching for watch\n      disableFSCache()\n\n      // start watch\n      watchlog('Watching for %s ...', name)\n      watchers.push(fs.watch(newpath, {\n        recursive: src.indexOf('/**/') !== -1\n      }, () => this.start(name, directory, recache, false)))\n    })\n\n    return new Promise(resolve => {\n      process.on('SIGINT', () => {\n        watchers.forEach(watcher => watcher.close())\n        resolve()\n      })\n    })\n  }\n\n  /**\n   * Handles bundling.\n   */\n  async startBundling (name, directory, modified, dest, useDoubleCache = true) {\n    const { log, debug } = createLogger(`hopp:${name}`)\n    debug('Switched to bundling mode')\n\n    /**\n     * Fetch sourcemap from cache.\n     */\n    const sourcemap = cache.sourcemap(name)\n\n    /**\n     * Get full list of current files.\n     */\n    const files = await glob(name, this.d.src, directory, useDoubleCache, true)\n\n    /**\n     * Create list of unmodified.\n     */\n    let freshBuild = true\n    const unmodified = Object.create(null)\n\n    for (let file of files) {\n      if (modified.indexOf(file) === -1) {\n        unmodified[file] = true\n        freshBuild = false\n      }\n    }\n\n    /**\n     * Get old bundle & create new one.\n     */\n    const originalFd = freshBuild ? null : await openFile(dest, 'r')\n    const [tmpBundle, tmpBundlePath] = await tmpFile()\n\n    /**\n     * Create new bundle to forward to.\n     */\n    const bundle = new Bundle(directory, tmpBundle)\n\n    /**\n     * Since bundling starts streaming right away, we can count this\n     * as the start of the build.\n     */\n    const start = Date.now()\n    log('Starting task')\n\n    /**\n     * Add all files.\n     */\n    for (let file of files) {\n      let stream\n\n      if (unmodified[file]) {\n        debug('forward: %s', file)\n        stream = fs.createReadStream(null, {\n          fd: originalFd,\n          autoClose: false,\n          start: sourcemap[file.replace(directory, '.')].start,\n          end: sourcemap[file.replace(directory, '.')].end\n        })\n      } else {\n        debug('transform: %s', file)\n        stream = pump([\n          createReadStream(file, dest + '/' + path.basename(file), directory)\n        ].concat(this.buildStack(name)))\n      }\n\n      bundle.add(file, stream)\n    }\n\n    /**\n     * Wait for bundling to end.\n     */\n    await bundle.end(tmpBundlePath)\n\n    /**\n     * Move the bundle to the new location.\n     */\n    if (originalFd) originalFd.close()\n    await mkdirp(path.dirname(dest).replace(directory, ''), directory)\n    await new Promise((resolve, reject) => {\n      const stream = fs.createReadStream(tmpBundlePath).pipe(fs.createWriteStream(dest))\n\n      stream.on('close', resolve)\n      stream.on('error', reject)\n    })\n\n    /**\n     * Update sourcemap.\n     */\n    cache.sourcemap(name, bundle.map)\n\n    log('Task ended (took %s ms)', Date.now() - start)\n  }\n\n  /**\n   * Converts all plugins in the stack into streams.\n   */\n  buildStack (name) {\n    const that = this\n\n    let mode = 'stream'\n\n    return this.d.stack.map(([plugin, method, plugName]) => {\n      const pluginStream = through2.obj(async function (data, _, done) {\n        try {\n          /**\n           * Grab args.\n           */\n          const args = (that.pluginArgs[plugName] || {})[method] || []\n\n          /**\n           * Try and get proper method - assume\n           * default by default.\n           */\n          const handler = plugins[plugin][method || 'default'](\n            Object.assign(\n              {},\n              that.pluginCtx[plugin],\n              { args }\n            ),\n            data\n          )\n\n          // for async functions/promises\n          if ('then' in handler) {\n            try {\n              this.push(await handler)\n              done()\n            } catch (err) {\n              done(simplifyError(err, new Error()))\n            }\n          } else if ('next' in handler) {\n            let retval\n\n            // for async generators\n            do {\n              retval = await handler.next()\n              this.push(retval.value)\n            } while (!retval.done)\n\n            done()\n          } else {\n            // otherwise, fail\n            done(new Error('Unknown return value received from ' + plugin))\n          }\n        } catch (err) {\n          done(simplifyError(err, new Error()))\n        }\n      })\n\n      /**\n       * Enable buffer mode if required.\n       */\n      if (mode === 'stream' && pluginConfig[plugin].mode === 'buffer') {\n        mode = 'buffer'\n        return pump(buffer(), pluginStream)\n      }\n\n      /**\n       * Otherwise keep pumping.\n       */\n      return pluginStream\n    })\n  }\n\n  /**\n   * Loads a plugin, manages its env.\n   */\n  loadPlugin (taskName, plugin, plugName, directory) {\n    let mod = plugins[plugin]\n\n    if (!mod) {\n      // convert plugin path from relative back to absolute\n      try {\n        let pathToPlugin = plugin\n\n        if (plugin[0] !== '/') {\n          const localPlugins = cache.valOr('lp', Object.create(null))\n          pathToPlugin = localPlugins[plugin] || path.join(directory, 'node_modules', plugin)\n        }\n\n        mod = require(pathToPlugin)\n      } catch (err) {\n        debug('failed to load plugin: %s', err && err.stack ? err.stack : err)\n        throw new Error('Failed to load plugin: ' + plugin)\n      }\n\n      // expose module config\n      pluginConfig[plugin] = mod.config || Object.create(null)\n\n      // add plugins to loaded plugins\n      plugins[plugin] = mod\n    }\n\n    // create plugin logger\n    const logger = createLogger(`${taskName}:${plugName}}`)\n\n    // load/create cache for plugin\n    const pluginCache = cache.plugin(plugin)\n\n    // create a new context for this plugin\n    this.pluginCtx[plugin] = {\n      args: [],\n      cache: pluginCache,\n      log: logger.log,\n      debug: logger.debug,\n      error: logger.error\n    }\n  }\n\n  /**\n   * Starts the pipeline.\n   * @return {Promise} resolves when task is complete\n   */\n  async start (name, directory, recache = false, useDoubleCache = true) {\n    const { log, debug, error } = createLogger(name)\n\n    /**\n     * Add timeout for safety.\n     */\n    const safeTimeout = setTimeout(() => {\n      error('Timeout exceeded! Task was hung.')\n      process.exit(-1)\n    }, 6e4)\n\n    /**\n     * Figure out if bundling is needed & load plugins.\n     */\n    if (isUndefined(this.needsBundling) || isUndefined(this.needsRecaching) || isUndefined(this.readonly) || (this.d.stack.length > 0 && !this.loadedPlugins)) {\n      this.loadedPlugins = true\n\n      this.d.stack.forEach(([plugin, _, plugName]) => {\n        if (!this.pluginCtx[plugin]) {\n          this.loadPlugin(name, plugin, plugName, directory)\n        }\n\n        this.needsBundling = !!(this.needsBundling || pluginConfig[plugin].bundle)\n        this.needsRecaching = !!(this.needsRecaching || pluginConfig[plugin].recache)\n        this.readonly = !!(this.readonly || pluginConfig[plugin].readonly)\n\n        if (this.needsBundling && this.readonly) {\n          throw new Error('Task chain enabled bundling and readonly mode at the same time. Not sure what to do.')\n        }\n      })\n    }\n\n    /**\n     * Override recaching.\n     */\n    if (this.needsRecaching) {\n      recache = true\n    }\n\n    /**\n     * Get the modified files.\n     */\n    debug('task recache = %s', recache)\n    let files = await glob(name, this.d.src, directory, useDoubleCache, recache)\n\n    /**\n     * Quit now if we want to build skipping.\n     */\n    if (process.env.SKIP_BUILD === 'true') {\n      log('Updated cache')\n      return\n    }\n\n    if (files.length > 0) {\n      const dest = this.d.dest ? path.resolve(directory, getPath(this.d.dest)) : ''\n\n      /**\n       * Switch to bundling mode if need be.\n       */\n      if (this.needsBundling) {\n        await this.startBundling(name, directory, files, dest, useDoubleCache)\n        clearTimeout(safeTimeout)\n        return\n      }\n\n      /**\n       * Ensure dist directory exists.\n       */\n      if (!this.readonly || !this.d.dest) {\n        await mkdirp(dest.replace(directory, ''), directory)\n      }\n\n      /**\n       * Create streams.\n       */\n      files = _(files).map(file => {\n        const outfile = this.doRename(path.basename(file), dest, file)\n\n        return {\n          file,\n          outfile,\n          stream: [\n            createReadStream(file, outfile, directory)\n          ]\n        }\n      })\n\n      /**\n       * Connect plugin streams with pipelines.\n       */\n      if (this.d.stack.length > 0) {\n        files.map(file => {\n          file.stream = file.stream.concat(this.buildStack(name))\n          return file\n        })\n      }\n\n      /**\n       * Connect with destination.\n       */\n      files.map(file => {\n        if (!this.readonly || !this.d.dest) {\n          // strip out the actual body and write it\n          file.stream.push(mapStream((data, next) => {\n            if (typeof data !== 'object' || !data.hasOwnProperty('body')) {\n              return next(new Error('A plugin has destroyed the stream by returning a non-object.'))\n            }\n\n            next(null, data.body)\n          }))\n\n          // add the writestream at the end\n          let output\n\n          if (!this.d.dest) {\n            const { fd: tmp, name: tmppath } = tmpFileSync()\n            output = fs.createWriteStream(null, {\n              fd: tmp\n            })\n\n            file.promise = didFail => new Promise((resolve, reject) => {\n              output.on('close', () => {\n                if (!didFail()) {\n                  const newStream =\n                    fs.createReadStream(tmppath)\n                      .pipe(fs.createWriteStream(file.file))\n\n                  newStream.on('error', reject)\n                  newStream.on('close', resolve)\n                }\n              })\n            })\n          } else {\n            debug('Set output: %s', file.outfile)\n            mkdirpSync(path.dirname(file.outfile).replace(directory, ''), directory)\n            output = fs.createWriteStream(file.outfile)\n          }\n\n          file.stream.push(output)\n        }\n\n        // promisify the current pipeline\n        return new Promise((resolve, reject) => {\n          let resolved = false\n          let didFail = false\n\n          // connect all streams together to form pipeline\n          file.stream = pump(file.stream, err => {\n            didFail = !!err\n\n            if (err) reject(simplifyError(err, new Error()))\n            else if (!resolved && !file.promise) resolve()\n          })\n\n          if (file.promise) {\n            file\n              .promise(() => didFail)\n              .then(() => {\n                resolved = true\n                resolve()\n              }, reject)\n          }\n        }).then(async () => {\n          // ensure global cache is present\n          if (gstatCache === undefined) {\n            gstatCache = cache.valOr('sc', Object.create(null))\n          }\n\n          // shorten task name based on hopp's internal convention\n          const taskName = name.split(':').pop()\n\n          // create local cache\n          if (gstatCache[taskName] === undefined) {\n            gstatCache[taskName] = Object.create(null)\n          }\n\n          const localCache = gstatCache[taskName]\n\n          // update file stat\n          localCache['./' + path.relative(directory, file.file)] = +fs.statSync(file.file).mtime\n        })\n      })\n\n      // start & wait for all pipelines to end\n      const start = Date.now()\n      log('Starting task for %s files', files.length)\n      await Promise.all(files.val())\n      log('Task ended (took %s ms)', Date.now() - start)\n\n      // clear the timeout\n      clearTimeout(safeTimeout)\n    } else {\n      log('Skipping task')\n    }\n  }\n\n  /**\n   * Converts task manager to JSON for storage.\n   * @return {Object} proper JSON object\n   */\n  toJSON () {\n    return {\n      d: this.d,\n      needsBundling: this.needsBundling,\n      needsRecaching: this.needsRecaching,\n      readonly: this.readonly\n    }\n  }\n\n  /**\n   * Deserializes a JSON object into a manager.\n   * @param {Object} json\n   * @return {Hopp} task manager\n   */\n  fromJSON (json) {\n    this.d = json.d\n    this.needsBundling = json.needsBundling\n    this.needsRecaching = json.needsRecaching\n    this.readonly = json.readonly\n\n    return this\n  }\n}\n\n/**\n * Extended prototype for plugins to be appended to.\n */\nHopp.fn = Object.create(null)\n"]}